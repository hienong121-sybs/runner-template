# ==============================================================================
# TAILSCALE-CLOUDFLARED CONFIGURATION (LINUX)
# ==============================================================================

services:
  tailscale:
    image: tailscale/tailscale:latest
    hostname: ${DOTENVRTDB_NOW_YYYYDDMMHH:-UNKNOW-DOTENVRTDB_NOW_YYYYDDMMHH}
    network_mode: "host"
    environment:
      - TS_AUTHKEY=${TAILSCALE_CLIENT_SECRET}
      - TS_USERSPACE=false
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SOCKET=/var/run/tailscale/tailscaled.sock
      - TS_EXTRA_ARGS=--advertise-tags=${TAILSCALE_TAGS:-tag:ci} --accept-dns=true --accept-routes
    volumes:
      - tailscale-data:/var/lib/tailscale
      - tailscale-socket:/var/run/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped

  pull-data:
    image: node:20-alpine
    depends_on:
      tailscale:
        condition: service_started
    network_mode: "service:tailscale"
    restart: "no"
    dns:
      - ${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - ${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
    environment:
      - TAILSCALE_TAILNET_DNS=${TAILSCALE_TAILNET_DNS}
      - TAILSCALE_DNS_SETUP_ENABLED=${TAILSCALE_DNS_SETUP_ENABLED:-1}
      - TAILSCALE_DNS_NAMESERVER_PRIMARY=${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - TAILSCALE_DNS_NAMESERVER_FALLBACK=${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
      - TAILSCALE_DNS_SEARCH_DOMAIN=${TAILSCALE_DNS_SEARCH_DOMAIN:-${TAILSCALE_TAILNET_DNS:-}}
      - HOST_CWD=${HOST_CWD:-${PWD}}
      - PULL_DATA_SYNC_DIRS=${PULL_DATA_SYNC_DIRS:-.pocketbase}
      - PULL_DATA_SSH_USER=${PULL_DATA_SSH_USER:-}
      - PULL_DATA_SSH_PORT=${PULL_DATA_SSH_PORT:-${SSH_PORT:-2222}}
      - PULL_DATA_SSH_KNOWN_HOSTS_FILE=${PULL_DATA_SSH_KNOWN_HOSTS_FILE:-}
      - SSH_PULL_DATA_PRIVATE_KEY_BASE64=${SSH_PULL_DATA_PRIVATE_KEY_BASE64:-}
      - TAILSCALE_CLIENT_ID=${TAILSCALE_CLIENT_ID:-${TAILSCALE_CLIENT_ID:-}}
      - TAILSCALE_CLIENT_SECRET=${TAILSCALE_CLIENT_SECRET:-${TAILSCALE_CLIENT_SECRET:-}}
      - TAILSCALE_TAILNET=${TAILSCALE_TAILNET:--}
      - TAILSCALE_API_BASE_URL=${TAILSCALE_API_BASE_URL:-https://api.tailscale.com}
      - PULL_DATA_CWD_PORT=${PULL_DATA_CWD_PORT:-8080}
      - PULL_DATA_HTTP_TIMEOUT_MS=${PULL_DATA_HTTP_TIMEOUT_MS:-5000}
    volumes:
      - ${HOST_CWD:-${PWD}}:${HOST_CWD:-${PWD}}
      - ./scripts/pull-data.js:/opt/pull-data.js:ro
      - ./scripts/setup-resolver.sh:/opt/common/setup-resolver.sh:ro
    entrypoint:
      - /bin/sh
      - -ec
      - |
        if command -v apk >/dev/null 2>&1; then
          apk add --no-cache rsync openssh-client >/dev/null
        fi
        sh /opt/common/setup-resolver.sh
        exec node /opt/pull-data.js

  nginx:
    image: nginx:1.27-alpine
    depends_on:
      tailscale:
        condition: service_started
      pull-data:
        condition: service_completed_successfully
    network_mode: "host"
    restart: unless-stopped
    dns:
      - ${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - ${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
    environment:
      - TAILSCALE_DNS_SETUP_ENABLED=${TAILSCALE_DNS_SETUP_ENABLED:-1}
      - TAILSCALE_DNS_NAMESERVER_PRIMARY=${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - TAILSCALE_DNS_NAMESERVER_FALLBACK=${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
      - TAILSCALE_DNS_SEARCH_DOMAIN=${TAILSCALE_DNS_SEARCH_DOMAIN:-${TAILSCALE_TAILNET_DNS:-}}
      - HOST_CWD=${HOST_CWD:-${PWD}}
      - MAIN_PORT=${MAIN_PORT:-3000}
      - MAIN_TARGET_DNS=${MAIN_TARGET_DNS:-127.0.0.1}
      - MAIN_TARGET_PORT=${MAIN_TARGET_PORT:-${MAIN_PORT:-3000}}
      - NGINX_PORT=${NGINX_PORT:-8080}
      - DOTENVRTDB_NOW_YYYYDDMMHH=${DOTENVRTDB_NOW_YYYYDDMMHH:-}
      - TAILSCALE_TAILNET_DNS=${TAILSCALE_TAILNET_DNS:-}
      - TAILSCALE_DNS_CURRENT=${TAILSCALE_DNS_CURRENT:-}
      - TAILSCALE_DNS_NEXTHOUR=${TAILSCALE_DNS_NEXTHOUR:-}
      - NGINX_MIRROR_ENABLED=${NGINX_MIRROR_ENABLED:-0}
      - NGINX_MIRROR_URL_PORT_00=${NGINX_MIRROR_URL_PORT_00:-}
      - NGINX_MIRROR_URL_PORT_01=${NGINX_MIRROR_URL_PORT_01:-}
      - NGINX_MIRROR_URL_PORT_02=${NGINX_MIRROR_URL_PORT_02:-}
      - NGINX_MIRROR_URL_PORT_03=${NGINX_MIRROR_URL_PORT_03:-}
      - NGINX_MIRROR_URL_PORT_04=${NGINX_MIRROR_URL_PORT_04:-}
      - NGINX_MIRROR_URL_PORT_05=${NGINX_MIRROR_URL_PORT_05:-}
      - NGINX_MIRROR_URL_PORT_06=${NGINX_MIRROR_URL_PORT_06:-}
      - NGINX_MIRROR_URL_PORT_07=${NGINX_MIRROR_URL_PORT_07:-}
      - NGINX_MIRROR_URL_PORT_08=${NGINX_MIRROR_URL_PORT_08:-}
      - NGINX_MIRROR_URL_PORT_09=${NGINX_MIRROR_URL_PORT_09:-}
      - NGINX_AUTH_USER_00=${NGINX_AUTH_USER_00:-}
      - NGINX_AUTH_PASS_00=${NGINX_AUTH_PASS_00:-}
      - NGINX_AUTH_USER_01=${NGINX_AUTH_USER_01:-}
      - NGINX_AUTH_PASS_01=${NGINX_AUTH_PASS_01:-}
    command:
      - /bin/sh
      - -ec
      - |
        sh /opt/nginx/entrypoint.sh
    volumes:
      - ${HOST_CWD:-${PWD}}:${HOST_CWD:-${PWD}}:ro
      - ./nginx/default.template.conf:/etc/nginx/templates/default.template.conf:ro
      - ./nginx/setup-htpasswd.sh:/opt/nginx/setup-htpasswd.sh:ro
      - ./nginx/entrypoint.sh:/opt/nginx/entrypoint.sh:ro
      - ./scripts/setup-resolver.sh:/opt/common/setup-resolver.sh:ro
      - ./.nginx:/opt/nginx/runtime

  caddy:
    image: caddy:2-alpine
    depends_on:
      nginx:
        condition: service_started
    network_mode: "host"
    restart: unless-stopped
    dns:
      - ${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - ${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
    environment:
      - TAILSCALE_DNS_SETUP_ENABLED=${TAILSCALE_DNS_SETUP_ENABLED:-1}
      - TAILSCALE_DNS_NAMESERVER_PRIMARY=${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - TAILSCALE_DNS_NAMESERVER_FALLBACK=${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
      - TAILSCALE_DNS_SEARCH_DOMAIN=${TAILSCALE_DNS_SEARCH_DOMAIN:-${TAILSCALE_TAILNET_DNS:-}}
      - CADDY_UPSTREAM_HOST=${CADDY_UPSTREAM_HOST:-127.0.0.1}
      - CADDY_UPSTREAM_PORT=${CADDY_UPSTREAM_PORT:-${NGINX_PORT:-8080}}
    command:
      - /bin/sh
      - -ec
      - |
        sh /opt/caddy/entrypoint.sh
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/entrypoint.sh:/opt/caddy/entrypoint.sh:ro
      - ./scripts/setup-resolver.sh:/opt/common/setup-resolver.sh:ro
      - ./.caddy:/opt/caddy/runtime
      - caddy-data:/data
      - caddy-config:/config

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    network_mode: "host"
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared-config.yml:/etc/cloudflared/config.yml:ro
      - ./cloudflared-credentials.json:/etc/cloudflared/credentials.json:ro

volumes:
  tailscale-data:
    driver: local
  tailscale-socket:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
