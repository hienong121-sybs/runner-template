# ==============================================================================
# TAILSCALE-CLOUDFLARED CONFIGURATION (LINUX)
# ==============================================================================

services:
  tailscale:
    image: tailscale/tailscale:latest
    hostname: ${USER:-local}-${GITHUB_RUN_ID:-${BUILD_BUILDID:-dev}}
    network_mode: "host"
    environment:
      - TS_AUTHKEY=${TAILSCALE_CLIENT_SECRET}
      - TS_USERSPACE=false
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SOCKET=/var/run/tailscale/tailscaled.sock
      - TS_EXTRA_ARGS=--advertise-tags=${TAILSCALE_TAGS:-tag:ci} --accept-dns=true --accept-routes
    volumes:
      - tailscale-data:/var/lib/tailscale
      - tailscale-socket:/var/run/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped

  pull-data:
    image: node:20-alpine
    depends_on:
      tailscale:
        condition: service_started
    network_mode: "service:tailscale"
    restart: "no"
    environment:
      - HOST_CWD=${HOST_CWD:-${PWD}}
      - PULL_DATA_SYNC_DIRS=${PULL_DATA_SYNC_DIRS:-.pocketbase}
      - PULL_DATA_SSH_USER=${PULL_DATA_SSH_USER:-}
      - PULL_DATA_SSH_PORT=${PULL_DATA_SSH_PORT:-${SSH_PORT:-2222}}
      - PULL_DATA_SSH_KNOWN_HOSTS_FILE=${PULL_DATA_SSH_KNOWN_HOSTS_FILE:-}
      - SSH_PULL_DATA_PRIVATE_KEY_BASE64=${SSH_PULL_DATA_PRIVATE_KEY_BASE64:-}
      - TAILSCALE_CLIENT_ID=${TAILSCALE_CLIENT_ID:-${TS_CLIENT_ID:-}}
      - TAILSCALE_CLIENT_SECRET=${TAILSCALE_CLIENT_SECRET:-${TS_CLIENT_SECRET:-}}
      - TAILSCALE_TAILNET=${TAILSCALE_TAILNET:--}
      - TAILSCALE_API_BASE_URL=${TAILSCALE_API_BASE_URL:-https://api.tailscale.com}
      - PULL_DATA_CWD_PORT=${PULL_DATA_CWD_PORT:-8080}
      - PULL_DATA_HTTP_TIMEOUT_MS=${PULL_DATA_HTTP_TIMEOUT_MS:-5000}
    volumes:
      - ${HOST_CWD:-${PWD}}:${HOST_CWD:-${PWD}}
      - ./scripts/pull-data.js:/opt/pull-data.js:ro
    entrypoint:
      - /bin/sh
      - -ec
      - |
        if command -v apk >/dev/null 2>&1; then
          apk add --no-cache rsync openssh-client >/dev/null
        fi
        exec node /opt/pull-data.js

  caddy:
    image: caddy:2-alpine
    depends_on:
      tailscale:
        condition: service_started
      pull-data:
        condition: service_completed_successfully
    network_mode: "host"
    restart: unless-stopped
    environment:
      - HOST_CWD=${HOST_CWD:-${PWD}}
      - MAIN_URL=${MAIN_URL:-127.0.0.1} # host or container_name: main-service
      - MAIN_PORT=${MAIN_PORT:-3000}
      - HOLD_URL=${HOLD_URL:-127.0.0.1} # host or container_name: hold-service
      - HOLD_PORT=${HOLD_PORT:-4000}
      - CADDY_DOMAIN=${CADDY_DOMAIN:-localhost}
      - NGINX_AUTH_USER_00=${NGINX_AUTH_USER_00:-}
      - NGINX_AUTH_PASS_00=${NGINX_AUTH_PASS_00:-}
      - NGINX_AUTH_USER_01=${NGINX_AUTH_USER_01:-}
      - NGINX_AUTH_PASS_01=${NGINX_AUTH_PASS_01:-}
    command:
      - /bin/sh
      - -ec
      - |
        sh /opt/caddy/entrypoint.sh
    volumes:
      - ${HOST_CWD:-${PWD}}:${HOST_CWD:-${PWD}}:ro
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/entrypoint.sh:/opt/caddy/entrypoint.sh:ro
      - caddy-data:/data
      - caddy-config:/config

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    network_mode: "host"
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared-config.yml:/etc/cloudflared/config.yml:ro
      - ./cloudflared-credentials.json:/etc/cloudflared/credentials.json:ro

volumes:
  tailscale-data:
    driver: local
  tailscale-socket:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
