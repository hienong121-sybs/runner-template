# Codex Changelog - 2026-02-12 - #05

## 1) Yêu cầu thay đổi
- [x] Khắc phục tình trạng `shadow.mirror.log` không có dòng dù đã gửi `POST /api/...`.

## 2) Cấu hình/env ảnh hưởng
- Không thêm env mới.

## 3) Tóm tắt thay đổi
- Sửa logic mirror để không phụ thuộc path của subrequest nội bộ `/__shadow`.
- Chỉ bật mirror ở route `^~ /api/` (thay vì toàn bộ `location /`).

## 4) Chi tiết thay đổi
- Root cause:
  - `do_mirror` trước đây có điều kiện theo `$uri`.
  - Khi vào subrequest `location = /__shadow`, `$uri` là `/__shadow`, làm `do_mirror=0` và return 204 sớm.
  - Kết quả: không đi proxy shadow và không ghi `shadow.mirror.log`.
- Fix:
  - `nginx/maps/mirror_rules.map`:
    - bỏ map theo path khỏi `do_mirror`
    - `do_mirror` chỉ dựa trên `X-Shadow` + method write.
  - `nginx/conf.d/app.conf.template`:
    - thêm `location ^~ /api/` có `mirror /__shadow`
    - bỏ mirror khỏi `location /`.

## 5) Git diff trọng tâm
```diff
diff --git a/nginx/maps/mirror_rules.map b/nginx/maps/mirror_rules.map
@@
-map "$mirror_by_header|$mirror_by_method|$mirror_by_path" $do_mirror {
+map "$mirror_by_header|$mirror_by_method" $do_mirror {
   default 0;
-  "1|1|1" 1;
+  "1|1" 1;
 }
```

```diff
diff --git a/nginx/conf.d/app.conf.template b/nginx/conf.d/app.conf.template
@@
+  location ^~ /api/ {
+    mirror /__shadow;
+    mirror_request_body on;
+    proxy_pass http://main_upstream;
+    ...
+  }
@@
-  location / {
-    proxy_pass http://main_upstream;
-    mirror /__shadow;
-    mirror_request_body on;
+  location / {
+    proxy_pass http://main_upstream;
     ...
   }
```

## 6) Verify đã chạy
- Không chạy test/lint theo yêu cầu.
- Rà cấu hình:
  - `nginx/maps/mirror_rules.map`
  - `nginx/conf.d/app.conf.template`

## 7) Commit message đề xuất
```text
fix(nginx-mirror): enable shadow logging by removing subrequest path gate and mirroring only /api
```
