# Codex Changelog - 2026-02-12 - #01

## 1) Yêu cầu thay đổi
- [x] Chuyển luồng Nginx từ generate conf động bằng script `.sh` sang shadow mirror file-based.
- [x] Giữ Caddy ở đầu vào (SSL/TLS vẫn terminate phía Cloudflare/Caddy flow hiện tại).
- [x] Rà soát và ghi nhận các nghiệp vụ/cấu hình hiện có rồi gắn vào cấu trúc mẫu `docs/nginx-shadow`.
- [x] Không chỉnh sửa bất kỳ file nào trong `docs/nginx-shadow` (chỉ dùng làm mẫu).
- [x] Bổ sung mount log Nginx trong container ra host để xem trực tiếp ngoài repo runtime folder.

## 2) Cấu hình/env ảnh hưởng
- Bỏ sử dụng runtime env mirror cũ:
  - `NGINX_MIRROR_ENABLED`
  - `NGINX_MIRROR_URL_PORT_*`
  - `TAILSCALE_DNS_CURRENT`
  - `TAILSCALE_DNS_NEXTHOUR`
- Giữ các env lõi cho upstream và DNS resolver:
  - `MAIN_TARGET_DNS`, `MAIN_TARGET_PORT`, `NGINX_PORT`
  - `TAILSCALE_DNS_NAMESERVER_PRIMARY`, `TAILSCALE_DNS_NAMESERVER_FALLBACK`, `TAILSCALE_DNS_SEARCH_DOMAIN`
- Thêm cấu hình envsubst output của Nginx image:
  - `NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx`
- Bổ sung mount log host:
  - `./.nginx/logs:/var/log/nginx`

## 3) Tóm tắt thay đổi
- Tổng quát:
  - Chuyển Nginx sang cấu trúc file-based theo chuẩn `conf.d + upstreams + maps + shadow-servers + scripts`.
  - Loại bỏ luồng mirror động bằng env và script entrypoint phức tạp.
  - Giữ nghiệp vụ `/files`, `/cwd`, `/healthz`, proxy main upstream, anti-loop, method/path filtering, audit log.
  - Đồng bộ tài liệu + danh sách file template copy/publish.
- Số file chạm tới: 20 file
  - Modified: 11
  - Added: 9

## 4) Chi tiết thay đổi

### 4.1 Runtime Nginx chuyển sang file-based shadow mirror
- File mới:
  - `nginx/conf.d/app.conf.template`
  - `nginx/upstreams/main_upstream.conf.template`
  - `nginx/upstreams/shadow_upstream.conf.template`
  - `nginx/maps/mirror_rules.map`
  - `nginx/shadow-servers/.gitkeep`
  - `nginx/scripts/shadow-add.sh`
  - `nginx/scripts/shadow-rm.sh`
  - `nginx/scripts/shadow-sync.sh`
- Mục tiêu:
  - Đưa mirror rules/backend về file cố định, tránh generate từng location từ env theo kiểu cũ.
  - Cho phép add/remove/sync shadow host bằng thao tác file + reload an toàn.
- Điểm chính:
  - Include upstream/rules: `nginx/conf.d/app.conf.template:1`
  - Audit log shadow: `nginx/conf.d/app.conf.template:106`
  - `/cwd` trả `startTime` runtime: `nginx/conf.d/app.conf.template:65`
  - Anti-loop `X-Shadow`: `nginx/maps/mirror_rules.map:1`
  - Filter method/path: `nginx/maps/mirror_rules.map:6`, `nginx/maps/mirror_rules.map:14`

### 4.2 Docker compose cập nhật theo luồng mới + mount logs
- File:
  - `docker-compose.yml`
- Nội dung:
  - Bỏ toàn bộ env mirror cũ `NGINX_MIRROR_*`.
  - Nginx dùng template dir mount (`/etc/nginx/templates/...`) + envsubst mặc định của image.
  - Runtime command chỉ còn set defaults/start-time + `setup-htpasswd` + start Nginx.
  - Mount logs: `./.nginx/logs:/var/log/nginx`.
- Tham chiếu:
  - envsubst output dir: `docker-compose.yml:78`
  - startup time export: `docker-compose.yml:98`
  - template mounts: `docker-compose.yml:103`
  - shadow backend dir mount: `docker-compose.yml:106`
  - log mount host: `docker-compose.yml:109`

### 4.3 Dọn logic script liên quan mirror env cũ
- File:
  - `scripts/setup-runner-prev.js`
  - `scripts/setup-runner-helper.js`
- Nội dung:
  - Xóa step auto-generate `NGINX_MIRROR_URL_PORT_00`.
  - Giữ DNS resolver sync step và đổi thành `step00_resolveDns`.
  - Xóa helper dead-code `pickProbeHost`/`parseHostFromUrlPort` (phụ thuộc mirror env cũ).
- Tham chiếu:
  - step mới: `scripts/setup-runner-prev.js:11`
  - summary mới: `scripts/setup-runner-prev.js:273`

### 4.4 Cập nhật hậu kiểm tra runtime log ở setup-runner-after
- File:
  - `scripts/setup-runner-after.js`
- Nội dung:
  - Bỏ check `.nginx/runtime.env` cũ.
  - Check trạng thái thư mục log host + shadow audit log.
  - Health check nginx (`step02_verifyNginxHealth`) đổi sang non-blocking mặc định:
    - timeout thì ghi `pending` và tiếp tục các step sau để vẫn xem được log/trạng thái compose
    - chỉ fail cứng khi bật `RUNNER_AFTER_HEALTH_REQUIRED=1`
- Tham chiếu:
  - `scripts/setup-runner-after.js:284`
  - `scripts/setup-runner-after.js:314`

### 4.5 Đồng bộ template/copy/publish/docs
- Files:
  - `package.json`
  - `runner-template-copy.js`
  - `README.md`
  - `.env.example`
  - `CHANGELOG.md`
- Nội dung:
  - Đổi danh sách file template sang bộ nginx mới.
  - Tài liệu runtime mirror đổi sang file-based.
  - Bổ sung hướng dẫn logs host (`./.nginx/logs`).

### 4.6 Legacy files
- Do hạn chế môi trường không xóa được file trực tiếp, legacy files được chuyển sang trạng thái deprecated (không còn được runtime tham chiếu):
  - `nginx/default.template.conf:1`
  - `nginx/entrypoint.sh:4`
  - `nginx/upstreams/shadow_upstream.conf:1`

### 4.7 Hotfix Nginx startup fail (mirror directive context)
- Lỗi ghi nhận:
  - `nginx: [emerg] "mirror" directive is not allowed here in /etc/nginx/conf.d/app.conf:79`
- Nguyên nhân:
  - `mirror` và `mirror_request_body` được đặt trong khối `if`, không hợp lệ với context của Nginx.
- Cách sửa:
  - Đưa `mirror /__shadow;` + `mirror_request_body on;` ra trực tiếp trong `location /`.
  - Chặn mirror theo rule bằng early-return trong `location = /__shadow`:
    - `if ($do_mirror = 0) { return 204; }`
- File:
  - `nginx/conf.d/app.conf.template`

### 4.8 Hotfix Nginx bind :80 conflict (Address in use)
- Lỗi ghi nhận:
  - `nginx: [emerg] bind() to [::]:80 failed (98: Address in use)`
  - `nginx: [emerg] still could not bind()`
- Nguyên nhân:
  - `NGINX_PORT` bị đặt thành `80` trong khi topology hiện tại dùng host network và Caddy giữ cổng `80`.
- Cách sửa:
  - `scripts/setup-runner-prev.js` thêm bước normalize runtime port trước khi `docker compose up`:
    - nếu `NGINX_PORT` rỗng/invalid hoặc bằng `80` thì ép về `8080` và persist lại `.env`
    - nếu `CADDY_UPSTREAM_PORT` được set nhưng invalid hoặc bằng `80` thì ép theo `NGINX_PORT` đã normalize
  - `scripts/setup-runner-after.js` health-check có remap khi phát hiện `NGINX_PORT=80`:
    - ưu tiên `CADDY_UPSTREAM_PORT`, nếu vẫn `80` thì fallback `8080`
- Files:
  - `scripts/setup-runner-prev.js`
  - `scripts/setup-runner-after.js`

## 5) Git diff trọng tâm
```diff
diff --git a/docker-compose.yml b/docker-compose.yml
@@
-      - NGINX_MIRROR_ENABLED=${NGINX_MIRROR_ENABLED:-0}
-      - NGINX_MIRROR_URL_PORT_00=${NGINX_MIRROR_URL_PORT_00:-}
+      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
@@
-        sh /opt/nginx/entrypoint.sh
+        export RUNNER_START_TIME="$${RUNNER_START_TIME:-$$(date -u +%Y-%m-%dT%H:%M:%SZ)}"
+        sh /opt/nginx/setup-htpasswd.sh
+        exec /docker-entrypoint.sh nginx -g 'daemon off;'
@@
-      - ./.nginx:/opt/nginx/runtime
+      - ./.nginx/logs:/var/log/nginx
```

```diff
diff --git a/scripts/setup-runner-prev.js b/scripts/setup-runner-prev.js
@@
-    const step00_populateMirrorSlot00FromDateTime = (() => {
-      ...
-    })();
-
-    const step01_resolveDns = (() => {
+    const step00_resolveDns = (() => {
@@
-    const step02_SumaryStep = (() => {
+    const step01_SumaryStep = (() => {
```

```diff
diff --git a/.env.example b/.env.example
@@
-NGINX_MIRROR_ENABLED=0
-NGINX_MIRROR_URL_PORT_00=
-NGINX_MIRROR_URL_PORT_01=
+# Shadow mirror is now file-based:
+# - Rules: nginx/maps/mirror_rules.map
+# - Shadow upstream list: nginx/shadow-servers/<ip>.conf
+# - Helper scripts: nginx/scripts/shadow-add.sh, shadow-rm.sh, shadow-sync.sh
```

## 6) Verify đã chạy
- `node --check scripts/setup-runner-prev.js`
- `node --check scripts/setup-runner-after.js`
- `node --check scripts/setup-runner-helper.js`
- `node --check runner-template-copy.js`
- `docker compose -f docker-compose.yml config`

## 7) Commit message đề xuất
```text
refactor(nginx): migrate to file-based shadow mirror and mount nginx logs to host

- replace dynamic mirror env flow with file-based nginx shadow layout
- add app/upstream/map/shadow-server scripts structure
- remove NGINX_MIRROR_* runtime dependency and slot00 auto-generate logic
- mount /var/log/nginx to ./.nginx/logs for host-side log inspection
- update docs, env example, template copy/publish lists
```

## 8) Tài liệu mẫu tham chiếu
- `docs/nginx-shadow/README.md`
- `docs/nginx-shadow/RULES.md`
- `docs/nginx-shadow/conf.d/app.conf`
- `docs/nginx-shadow/maps/mirror_rules.map`
- `docs/nginx-shadow/upstreams/main_upstream.conf`
- `docs/nginx-shadow/upstreams/shadow_upstream.conf`
