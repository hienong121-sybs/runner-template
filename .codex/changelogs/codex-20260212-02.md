# Codex Changelog - 2026-02-12 - #02

## 1) Yêu cầu thay đổi
- [x] Tiếp tục triển khai `tasks/task01.md` theo luồng hiện tại, không làm vỡ cấu trúc runtime.
- [x] Chuyển `docker-compose.yml` từ base64 string sang YAML thuần để chỉnh trực tiếp.
- [x] Bổ sung service `docker-manager` điều khiển Docker/Tailscale/Nginx qua Docker socket.
- [x] Bổ sung API `dockerapi/*`, trả dạng text command-line.
- [x] Phân nhóm lệnh `safe`/`dangerous`, mặc định full-enable, có env prefix `DOCKER_MANAGER_*` để kiểm soát.
- [x] Thêm luồng scheduler tailscale, sync shadow IP file-based và reload nginx không downtime (`nginx -t` trước reload).
- [x] Ghi log runtime ra mount host `./.docker-manager`.
- [x] Không chạy test/lint theo yêu cầu.

## 2) Cấu hình/env ảnh hưởng
- Nhóm env mới (mặc định full):
  - `DOCKER_MANAGER_PORT`, `DOCKER_MANAGER_LOG_FILE`
  - `DOCKER_MANAGER_MAX_BODY_BYTES`, `DOCKER_MANAGER_COMMAND_TIMEOUT_MS`
  - `DOCKER_MANAGER_MAX_LOG_LINES`, `DOCKER_MANAGER_DEFAULT_LOG_TAIL`
  - `DOCKER_MANAGER_TAILSCALE_SYNC_ENABLED`, `DOCKER_MANAGER_TAILSCALE_SYNC_INTERVAL_SEC`
  - `DOCKER_MANAGER_TAILSCALE_CONTAINER`, `DOCKER_MANAGER_NGINX_CONTAINER`
  - `DOCKER_MANAGER_SHADOW_PORT`
  - `DOCKER_MANAGER_ENABLE_SAFE_COMMANDS`, `DOCKER_MANAGER_ENABLE_DANGEROUS_COMMANDS`
  - `DOCKER_MANAGER_ALLOWED_SAFE_COMMANDS`, `DOCKER_MANAGER_ALLOWED_DANGEROUS_COMMANDS`
  - `DOCKER_MANAGER_BLOCKED_COMMANDS`, `DOCKER_MANAGER_EXEC_SHELL`
- Nginx thêm env phục vụ proxy `dockerapi`:
  - `DOCKER_MANAGER_PORT`

## 3) Tóm tắt thay đổi
- Tổng quát:
  - Đã chuyển `docker-compose.yml` sang YAML thuần.
  - Đã thêm runtime `docker-manager` mới, có cấu trúc module rõ ràng và logging/try-catch đầy đủ.
  - Đã nối route `location /dockerapi/` vào nginx với auth `.htpasswd`.
  - Đã đồng bộ tài liệu/template copy/publish và env mẫu.
- Số file chạm tới: 17 file
  - Modified: 8
  - Added: 9

## 4) Chi tiết thay đổi

### 4.1 Chuyển docker-compose sang YAML thuần + thêm service docker-manager
- File:
  - `docker-compose.yml`
- Nội dung:
  - Replace toàn bộ base64 string thành YAML thuần.
  - Thêm service `docker-manager`:
    - mount docker socket: `/var/run/docker.sock:/var/run/docker.sock`
    - mount log runtime: `./.docker-manager:/opt/docker-manager/runtime`
    - mount shadow dir: `./nginx/shadow-servers:/opt/nginx/shadow-servers`
    - cài `docker-cli` trong container runtime.
  - Nginx nhận thêm `DOCKER_MANAGER_PORT` để proxy `/dockerapi`.
- Tham chiếu:
  - `docker-compose.yml:84`
  - `docker-compose.yml:114`
  - `docker-compose.yml:156`

### 4.2 Bổ sung docker-manager app theo cấu trúc module
- Files mới:
  - `docker-manager/index.js`
  - `docker-manager/lib/config.js`
  - `docker-manager/lib/logger.js`
  - `docker-manager/lib/command-runner.js`
  - `docker-manager/lib/docker-client.js`
  - `docker-manager/lib/tailscale-shadow-sync.js`
  - `docker-manager/template.js`
- Nội dung:
  - `config.js`: đọc env `DOCKER_MANAGER_*`, policy command safe/dangerous.
  - `logger.js`: log console + append file JSON line.
  - `command-runner.js`: chạy command có timeout/capture stdout/stderr.
  - `docker-client.js`: wrapper command Docker/Tailscale/Nginx/Container/System.
  - `tailscale-shadow-sync.js`: parse `tailscale status --json`, sync shadow files, rollback nếu nginx test fail.
  - `index.js`: HTTP server route `/dockerapi/*`, scheduler định kỳ, health/help.
- Tham chiếu:
  - `docker-manager/lib/config.js:109`
  - `docker-manager/index.js:278`
  - `docker-manager/index.js:770`
  - `docker-manager/lib/tailscale-shadow-sync.js:158`

### 4.3 API dockerapi + nhóm lệnh safe/dangerous (mặc định full)
- File:
  - `docker-manager/index.js`
  - `docker-manager/lib/config.js`
- Nội dung:
  - Endpoints mẫu:
    - `GET /dockerapi/healthz`
    - `GET /dockerapi/help`
    - `GET /dockerapi/tailscale/status`
    - `POST /dockerapi/tailscale/ping`
    - `GET /dockerapi/nginx/test`
    - `POST /dockerapi/nginx/reload`
    - `GET /dockerapi/nginx/version`
    - `GET /dockerapi/system/ps`
    - `GET /dockerapi/{container}/status|logs|inspect|top|stats`
    - `POST /dockerapi/{container}/start|stop|restart|pause|unpause|kill|rm|exec|rename|update|raw`
  - Policy mặc định full:
    - `DOCKER_MANAGER_ALLOWED_SAFE_COMMANDS=*`
    - `DOCKER_MANAGER_ALLOWED_DANGEROUS_COMMANDS=*`
  - Có thể chặn riêng bằng `DOCKER_MANAGER_BLOCKED_COMMANDS`.
- Tham chiếu:
  - `docker-manager/lib/config.js:128`
  - `docker-manager/index.js:42`
  - `docker-manager/index.js:350`
  - `docker-manager/index.js:434`

### 4.4 Tailscale scheduler -> shadow files -> reload nginx an toàn
- File:
  - `docker-manager/lib/tailscale-shadow-sync.js`
  - `docker-manager/index.js`
- Nội dung:
  - Chu kỳ theo `DOCKER_MANAGER_TAILSCALE_SYNC_INTERVAL_SEC`.
  - Mỗi lần check:
    - lấy peers active (bỏ self)
    - so sánh `previousIps`/`nextIps`, tính `added`/`removed`
    - chỉ apply/reload khi có thay đổi
    - rollback state cũ nếu reload fail.
- Tham chiếu:
  - `docker-manager/lib/tailscale-shadow-sync.js:119`
  - `docker-manager/lib/tailscale-shadow-sync.js:186`
  - `docker-manager/index.js:315`

### 4.5 Nginx route `/dockerapi` có auth `.htpasswd`
- File:
  - `nginx/conf.d/app.conf.template`
- Nội dung:
  - Thêm `location ^~ /dockerapi/`:
    - `auth_basic` + `auth_basic_user_file /etc/nginx/auth/.htpasswd`
    - `proxy_pass http://127.0.0.1:${DOCKER_MANAGER_PORT}`
- Tham chiếu:
  - `nginx/conf.d/app.conf.template:75`
  - `nginx/conf.d/app.conf.template:79`

### 4.6 Đồng bộ template/documentation/publish
- Files:
  - `.env.example`
  - `README.md`
  - `package.json`
  - `runner-template-copy.js`
  - `.gitignore`
  - `.docker-manager/.gitkeep`
  - `CHANGELOG.md`
- Nội dung:
  - Thêm env mẫu `DOCKER_MANAGER_*`.
  - Thêm danh sách file copy/publish cho `docker-manager`.
  - Thêm docs runtime `dockerapi` + log mount `./.docker-manager`.
  - Ignore runtime files trong `.docker-manager` (giữ `.gitkeep`).

## 5) Git diff trọng tâm
```diff
diff --git a/docker-compose.yml b/docker-compose.yml
@@
-IyA9PT09PT09PT09PT09... (base64 content)
+services:
+  ...
+  docker-manager:
+    image: node:20-alpine
+    volumes:
+      - /var/run/docker.sock:/var/run/docker.sock
+      - ./.docker-manager:/opt/docker-manager/runtime
```

```diff
diff --git a/nginx/conf.d/app.conf.template b/nginx/conf.d/app.conf.template
@@
+  location ^~ /dockerapi/ {
+    auth_basic "Protected Docker API";
+    auth_basic_user_file /etc/nginx/auth/.htpasswd;
+    proxy_pass http://127.0.0.1:${DOCKER_MANAGER_PORT};
+  }
```

```diff
diff --git a/.env.example b/.env.example
@@
+DOCKER_MANAGER_PORT=18080
+DOCKER_MANAGER_ENABLE_SAFE_COMMANDS=1
+DOCKER_MANAGER_ENABLE_DANGEROUS_COMMANDS=1
+DOCKER_MANAGER_ALLOWED_SAFE_COMMANDS=*
+DOCKER_MANAGER_ALLOWED_DANGEROUS_COMMANDS=*
```

## 6) Verify đã chạy
- Không chạy test/lint theo yêu cầu.
- Đã rà thủ công toàn bộ file thay đổi và wiring giữa:
  - `docker-compose.yml`
  - `nginx/conf.d/app.conf.template`
  - `docker-manager/*`
  - template copy/publish/docs.

## 7) Commit message đề xuất
```text
feat(docker-manager): add dockerapi service with tailscale shadow sync and convert compose to plain yaml

- convert docker-compose.yml from base64 blob to plain yaml
- add docker-manager runtime service with docker socket mount and host log mount
- add dockerapi endpoints with safe/dangerous command policy via DOCKER_MANAGER_*
- add periodic tailscale status sync to nginx shadow files with nginx -t + rollback
- proxy /dockerapi through nginx with htpasswd auth
- update env example, docs, package publish/copy lists, and codex changelog
```
