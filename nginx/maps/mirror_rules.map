map $http_x_shadow $mirror_by_header {
  default 1;
  "1"     0;
}

map $request_method $mirror_by_method {
  default 0;
  POST    1;
  PUT     1;
  PATCH   1;
  DELETE  1;
}

map $uri $mirror_by_path {
  default 0;

  ~^/api/                          1;

  ~^/(health|healthz|metrics)$     0;
  ~^/(files|static)/               0;
  ~^/__shadow                      0;
}

map "$mirror_by_header|$mirror_by_method|$mirror_by_path" $do_mirror {
  default 0;
  "1|1|1" 1;
}
